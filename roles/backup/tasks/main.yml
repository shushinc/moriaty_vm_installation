---
- name: Ensure nginx group exists on DB nodes
  become: yes
  group:
    name: nginx
    state: present
  when: "'db_primary' in group_names or 'db_replicas' in group_names"
  tags: backup

- name: Ensure devportal user exists on DB nodes
  become: yes
  user:
    name: devportal
    group: nginx
    shell: /sbin/nologin
    create_home: no
    system: yes
    state: present
  when: "'db_primary' in group_names or 'db_replicas' in group_names"
  tags: backup

- name: Ensure moriarty backup directory structure exists
  become: yes
  file:
    path: "{{ item }}"
    state: directory
    owner: devportal
    group: nginx
    mode: '0755'
  loop:
    - "{{ backup_base_dir }}"
    - "{{ backup_base_dir }}/runtime"
    - "{{ backup_base_dir }}/database"
  tags: backup

- name: Set a single backup timestamp (controller-side)
  set_fact:
    backup_timestamp: "{{ lookup('pipe', 'date +%Y%m%dT%H%M%S%N') }}"
  run_once: true
  delegate_to: localhost
  tags: [backup]

- name: Share backup timestamp with all hosts
  set_fact:
    backup_timestamp: "{{ hostvars[groups['runtime'][0]].backup_timestamp | default(hostvars['localhost'].backup_timestamp) }}"
  tags: [backup]


- name: Backup moriarty runtime (shushportal)
  become: yes
  become_user: devportal
  archive:
    path: "{{ drupal_root }}"
    dest: "{{ backup_base_dir }}/runtime/shushportal-{{ backup_timestamp }}.tar.gz"
    format: gz
    exclude_path:
      - "{{ drupal_root }}/.git"
      - "{{ drupal_root }}/.ddev"
  when: is_drush_target | default(false)
  tags: backup


- name: Backup moriaty database (PRIMARY only)
  become: yes
  shell: |
    mysqldump \
      --single-transaction \
      --routines \
      --triggers \
      --events \
      -u {{ db_user }} -p'{{ db_password }}' \
      moriaty \
      | gzip -9 \
      > {{ backup_base_dir }}/database/moriaty-{{ backup_timestamp }}.sql.gz
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['db_primary'][0]
  tags: backup

- name: Backup metabase_db database (PRIMARY only)
  become: yes
  shell: |
    mysqldump \
      --single-transaction \
      --routines \
      --triggers \
      --events \
      -u {{ db_user }} -p'{{ db_password }}' \
      metabase_db \
      | gzip -9 \
      > {{ backup_base_dir }}/database/metabase_db-{{ backup_timestamp }}.sql.gz
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['db_primary'][0]
  tags: backup