---
# OS
- name: Set MySQL facts per OS
  set_fact:
    mysql_service_name: "{{ 'mysqld' if ansible_os_family == 'RedHat' else 'mysql' }}"
    mysql_socket: "{{ '/var/lib/mysql/mysql.sock' if ansible_os_family == 'RedHat' else '/var/run/mysqld/mysqld.sock' }}"
    mysql_config_file: "{{ '/etc/my.cnf.d/server.cnf' if ansible_os_family == 'RedHat' else '/etc/mysql/mysql.conf.d/zz-gtid.cnf' }}"
  tags: [mysql, mysql_install, mysql_config, mysql_prereqs]

# selinux
- name: (SELinux) ensure tools present
  package:
    name: policycoreutils-python-utils
    state: present
  when: ansible_os_family == "RedHat"
  tags: [mysql, mysql_install]

# instll all req packages
- name: Install MySQL server + prereqs (Debian/Ubuntu)
  apt:
    name:
      - mysql-server
      - python3-pymysql
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"
  tags: [mysql, mysql_install, mysql_prereqs]

- name: Install MySQL server + prereqs (Rocky/RedHat)
  dnf:
    name:
      - mysql-server
      - python3-PyMySQL
    state: present
    update_cache: yes
  when: ansible_os_family == "RedHat"
  tags: [mysql, mysql_install, mysql_prereqs]

# GTID
- name: Write MySQL GTID config (per-role differences)
  copy:
    dest: "{{ mysql_config_file }}"
    owner: root
    group: root
    mode: "0644"
    content: |
      {% set sid = (((inventory_hostname | hash('sha1'))[0:8] | int(base=16)) % 4294967294) + 1 %}
      [mysqld]
      server-id = {{ sid }}

      bind-address = 0.0.0.0

      # Binlog / replication basics
      log_bin = mysql-bin
      binlog_format = ROW

      # GTID
      gtid_mode = ON
      enforce_gtid_consistency = ON
      log_replica_updates = ON

      # Housekeeping
      binlog_expire_logs_seconds = 2592000
      binlog_row_image = FULL

      {% if inventory_hostname in groups['db_primary'] %}
      # PRIMARY
      innodb_flush_log_at_trx_commit = 1
      sync_binlog = 1
      {% else %}
      # REPLICA
      relay_log = relay-bin
      {% endif %}
  notify: Restart MySQL
  tags: [mysql, mysql_config]

- name: Flush handlers so MySQL restarts before replication configuration
  meta: flush_handlers
  tags: [mysql, mysql_config, mysql_seed, mysql_replication]


- name: Ensure MySQL data dir exists and owned by mysql
  file:
    path: /var/lib/mysql
    state: directory
    owner: mysql
    group: mysql
    mode: "0700"
  tags: [mysql, mysql_install]

- name: Restore SELinux contexts on MySQL paths (RedHat only)
  command: restorecon -Rv /var/lib/mysql /etc/my.cnf /etc/my.cnf.d
  changed_when: false
  failed_when: false
  when: ansible_os_family == "RedHat"
  tags: [mysql, mysql_install]

#make sure server is runnning
- name: Ensure MySQL service is enabled and running
  service:
    name: "{{ mysql_service_name }}"
    state: started
    enabled: yes
  tags: [mysql, mysql_install, mysql_config]


- name: Check GTID variables (replicas)
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
    query: "SELECT @@GLOBAL.gtid_mode, @@GLOBAL.enforce_gtid_consistency, @@GLOBAL.server_id"
  register: gtid_check
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_replication, mysql_check]

- name: Normalize GTID check row (replicas)
  set_fact:
    _gtid_row: >-
      {{
        (
          gtid_check.query_result[0][0]
          if (gtid_check.query_result is defined and gtid_check.query_result|length > 0 and gtid_check.query_result[0]|length > 0)
          else {}
        )
      }}
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_replication, mysql_check]

- name: Fail if GTID is not enabled (replicas)
  fail:
    msg: >-
      GTID not enabled on {{ inventory_hostname }}.
      Raw query_result={{ gtid_check.query_result | default('MISSING') }}
  when:
    - inventory_hostname in groups['db_replicas']
    - (_gtid_row == {}) or (_gtid_row[0] is defined and _gtid_row[0] != 'ON')
  tags: [mysql, mysql_replication, mysql_check]

# procysql user and access
- name: (ProxySQL) Temporarily disable read_only on REPLICAS
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
    query:
      - "SET GLOBAL super_read_only=OFF"
      - "SET GLOBAL read_only=OFF"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_grants, proxysql]

- name: Create ProxySQL monitor user (on all DB hosts)
  community.mysql.mysql_user:
    name: proxysql_monitor
    host: "10.%"
    password: "{{ proxysql_monitor_password }}"
    priv: "*.*:USAGE"
    plugin: mysql_native_password
    state: present
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
  when: inventory_hostname in groups['db_primary'] or inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_grants, proxysql]

- name: Grant specific monitor privileges (on all DB hosts)
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
    query:
      - "GRANT SELECT ON performance_schema.threads TO 'proxysql_monitor'@'10.%'"
      - "GRANT SELECT ON performance_schema.replication_group_members TO 'proxysql_monitor'@'10.%'"
      - "GRANT SELECT ON performance_schema.replication_applier_status_by_worker TO 'proxysql_monitor'@'10.%'"
      - "GRANT SELECT ON mysql.slave_master_info TO 'proxysql_monitor'@'10.%'"
      - "GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO 'proxysql_monitor'@'10.%'"
  when: inventory_hostname in groups['db_primary'] or inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_grants, proxysql]

- name: (ProxySQL) Re-enable read_only on REPLICAS
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
    query:
      - "SET GLOBAL read_only=ON"
      - "SET GLOBAL super_read_only=ON"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_grants, proxysql]

# replica user - primary

- name: Create replication user (primary only)
  community.mysql.mysql_user:
    name: repl
    host: "10.%"
    password: "{{ repl_password }}"
    priv: "*.*:REPLICATION SLAVE"
    plugin: mysql_native_password
    update_password: on_create
    state: present
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_primary_init]


- name: Copy external Drupal dump to PRIMARY
  copy:
    src: "{{ role_path }}/templates/zcs_new.sql.gz"
    dest: /tmp/zcs_new.sql.gz
    mode: "0644"
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed_external]

- name: Ensure plain SQL exists on PRIMARY (gunzip)
  shell: gunzip -c /tmp/zcs_new.sql.gz > /tmp/zcs_new.sql
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed_external]

- name: Import external dump into PRIMARY
  community.mysql.mysql_db:
    name: "{{ db_name }}"
    state: import
    target: /tmp/zcs_new.sql
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed_external]

# moriarty user 
- name: Collect web node IPs from 'runtime' group
  set_fact:
    _web_ips: >-
      {{
        groups.get('runtime', [])
        | map('extract', hostvars, 'ansible_host')
        | select('defined')
        | list
      }}
  when: inventory_hostname in groups['db_primary'] or inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_grants]

- name: Build host grant list for Drupal user
  set_fact:
    _drupal_grant_hosts: "{{ (['%','10.%'] + (_web_ips | default([]))) | unique }}"
  when: inventory_hostname in groups['db_primary'] or inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_grants]

- name: (Drupal User) Temporarily disable read_only on REPLICAS
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
    query:
      - "SET GLOBAL super_read_only=OFF"
      - "SET GLOBAL read_only=OFF"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_grants]

- name: Ensure Drupal user can connect from all allowed hosts
  community.mysql.mysql_user:
    name: "{{ db_user }}"
    host: "{{ item }}"
    password: "{{ db_password }}"
    priv: "{{ db_name }}.*:ALL"
    plugin: mysql_native_password
    update_password: on_create
    state: present
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
  loop: "{{ _drupal_grant_hosts }}"
  when: inventory_hostname in groups['db_primary'] or inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_grants]

- name: (Drupal User) Re-enable read_only on REPLICAS
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
    query:
      - "SET GLOBAL read_only=ON"
      - "SET GLOBAL super_read_only=ON"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_grants]


- name: Create GTID-aware dump on PRIMARY
  shell: >
    mysqldump --single-transaction --quick --routines --triggers
    --master-data=2 --set-gtid-purged=ON
    --databases {{ db_name }} | gzip > /tmp/seed.sql.gz
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed]

- name: Fetch seed dump to controller
  fetch:
    src: /tmp/seed.sql.gz
    dest: "/tmp/mysql-seed.sql.gz"
    flat: yes
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed]

- name: Push seed dump to REPLICAS
  copy:
    src: "/tmp/mysql-seed.sql.gz"
    dest: /tmp/seed.sql.gz
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: STOP REPLICA on replicas (ignore if clean)
  community.mysql.mysql_replication:
    mode: stopreplica
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
  ignore_errors: yes
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: RESET REPLICA ALL and RESET MASTER (force clean GTIDs)
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
    query:
      - "RESET REPLICA ALL"
      - "RESET MASTER"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: Disable read_only/super_read_only on REPLICAS for initial import
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
    query:
      - "SET GLOBAL super_read_only=OFF"
      - "SET GLOBAL read_only=OFF"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: Ensure plain SQL exists on REPLICAS
  shell: gunzip -c /tmp/seed.sql.gz > /tmp/seed.sql
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: Import plain SQL on REPLICAS (applies SET @@GLOBAL.GTID_PURGED)
  community.mysql.mysql_db:
    name: "{{ db_name }}"
    state: import
    target: /tmp/seed.sql
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: Re-enable read_only/super_read_only on REPLICAS after import
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
    query:
      - "SET GLOBAL read_only=ON"
      - "SET GLOBAL super_read_only=ON"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

# =========================
# Configure replication (GTID auto-position)
# =========================
- name: CHANGE PRIMARY (GTID) on replicas
  community.mysql.mysql_replication:
    mode: changeprimary
    master_host: "{{ hostvars[groups['db_primary'][0]].ansible_host | default(groups['db_primary'][0]) }}"
    master_user: "repl"
    master_password: "{{ repl_password }}"
    master_port: 3306
    master_auto_position: yes
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_replication]

- name: START REPLICA on replicas
  community.mysql.mysql_replication:
    mode: startreplica
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_replication]

- name: Get replication status (replicas)
  community.mysql.mysql_replication:
    mode: getreplica
    login_user: root
    login_unix_socket: "{{ mysql_socket }}"
  register: repl_status
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_check]

- name: Show replication summary (replicas)
  debug:
    var: repl_status
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_check]

- name: Check mysqld is listening on 3306
  shell: "ss -lntp | grep ':3306 ' || true"
  register: listen_3306
  changed_when: false
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_check]

- name: Fail if mysqld is not listening on 0.0.0.0 / primary IP
  fail:
    msg: "MySQL is not listening on port 3306 externally on {{ inventory_hostname }}. ss output: {{ listen_3306.stdout }}"
  when:
    - inventory_hostname in groups['db_primary']
    - listen_3306.stdout == ""
  tags: [mysql, mysql_check]

