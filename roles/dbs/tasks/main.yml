---
- name: (SELinux) ensure tools present
  package:
    name: policycoreutils-python-utils
    state: present
  when: ansible_os_family == "RedHat"
  tags: [mysql, mysql_install]

- name: Install MySQL server
  dnf:
    name: mysql-server
    state: present
    update_cache: yes
  tags: [mysql, mysql_install]

- name: Write /etc/my.cnf.d/server.cnf (GTID + ROW, per-role differences)
  copy:
    dest: /etc/my.cnf.d/server.cnf
    owner: root
    group: root
    mode: '0644'
    content: |
      {% set sid = (((inventory_hostname | hash('sha1'))[0:8] | int(base=16)) % 4294967294) + 1 %}
      [mysqld]
      server-id = {{ sid }}
      binlog_format = ROW
      gtid_mode = ON
      enforce_gtid_consistency = ON
      log_replica_updates = ON
      binlog_expire_logs_seconds = 2592000
      binlog_row_image = FULL

      {% if inventory_hostname in groups['db_primary'] %}
      # PRIMARY
      log_bin = mysql-bin
      innodb_flush_log_at_trx_commit = 1
      sync_binlog = 1
      {% else %}
      # REPLICA
      read_only = ON
      super_read_only = ON
      relay_log = relay-bin
      log_bin = mysql-bin
      {% endif %}
  notify: Restart MySQL
  tags: [mysql, mysql_config]

- name: Ensure MySQL data dir exists and owned by mysql
  file:
    path: /var/lib/mysql
    state: directory
    owner: mysql
    group: mysql
    mode: '0700'
  tags: [mysql, mysql_install]

- name: Restore SELinux contexts on MySQL paths
  command: restorecon -Rv /var/lib/mysql /etc/my.cnf /etc/my.cnf.d
  changed_when: false
  failed_when: false
  when: ansible_os_family == "RedHat"
  tags: [mysql, mysql_install]

- name: Ensure MySQL service is enabled and running
  service:
    name: mysqld
    state: started
    enabled: yes
  tags: [mysql, mysql_install, mysql_config]

- name: Create replication user (primary only)
  community.mysql.mysql_user:
    name: "repl"
    host: "10.%"
    password: "{{ repl_password }}"
    priv: "*.*:REPLICATION SLAVE"
    plugin: mysql_native_password
    update_password: on_create
    state: present
    login_user: root
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_primary_init]


- name: Create replication user (primary only)
  community.mysql.mysql_user:
    name: "repl"
    host: "10.%"
    password: "{{ repl_password }}"
    priv: "*.*:REPLICATION SLAVE"
    plugin: mysql_native_password
    update_password: on_create
    state: present
    login_user: root
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_primary_init]

- name: Copy external Drupal dump to PRIMARY
  copy:
    src: "{{ role_path }}/templates/zcs_new.sql.gz"
    dest: /tmp/zcs_new.sql.gz
    mode: '0644'
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed_external]

- name: Ensure plain SQL exists on PRIMARY (gunzip)
  shell: gunzip -c /tmp/zcs_new.sql.gz > /tmp/zcs_new.sql
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed_external]

- name: Import external dump into PRIMARY
  community.mysql.mysql_db:
    name: "{{ db_name }}"
    state: import
    target: /tmp/zcs_new.sql
    login_user: root
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed_external]


# give moriarty user grants

- name: Collect web node IPs from 'runtime' group
  set_fact:
    _web_ips: >-
      {{
        groups.get('runtime', [])
        | map('extract', hostvars, 'ansible_host')
        | select('defined')
        | list
      }}
  when: inventory_hostname in groups['db_primary']

- name: Build host grant list for Drupal user
  set_fact:
    _drupal_grant_hosts: >-
      {{
        (['%','10.%'] + (_web_ips | default([])))
        | unique
      }}
  when: inventory_hostname in groups['db_primary']

- name: Ensure Drupal user can connect from all allowed hosts
  community.mysql.mysql_user:
    name: "{{ db_user }}"
    host: "{{ item }}"
    password: "{{ db_password }}"
    priv: "{{ db_name }}.*:ALL"
    plugin: mysql_native_password
    update_password: on_create
    state: present
    login_user: root
  loop: "{{ _drupal_grant_hosts }}"
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_grants]

- name: Create GTID-aware dump on PRIMARY
  shell: >
    mysqldump --single-transaction --quick --routines --triggers
    --master-data=2 --set-gtid-purged=ON
    --databases {{ db_name }} | gzip > /tmp/seed.sql.gz
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed]

- name: Fetch seed dump to controller
  fetch:
    src: /tmp/seed.sql.gz
    dest: "/tmp/mysql-seed.sql.gz"
    flat: yes
  when: inventory_hostname in groups['db_primary']
  tags: [mysql, mysql_seed]

- name: Push seed dump to REPLICAS
  copy:
    src: "/tmp/mysql-seed.sql.gz"
    dest: /tmp/seed.sql.gz
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: STOP REPLICA on replicas (ignore if clean)
  community.mysql.mysql_replication:
    mode: stopreplica
    login_user: root
  ignore_errors: yes
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: RESET REPLICA ALL and RESET MASTER (force clean GTIDs)
  community.mysql.mysql_query:
    login_user: root
    query:
      - "RESET REPLICA ALL"
      - "RESET MASTER"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: Disable read_only/super_read_only on REPLICAS for initial import
  community.mysql.mysql_query:
    login_user: root
    query:
      - "SET GLOBAL super_read_only=OFF"
      - "SET GLOBAL read_only=OFF"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: Ensure plain SQL exists on REPLICAS
  shell: gunzip -c /tmp/seed.sql.gz > /tmp/seed.sql
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: Import plain SQL on REPLICAS (applies SET @@GLOBAL.GTID_PURGED)
  community.mysql.mysql_db:
    name: "{{ db_name }}"
    state: import
    target: /tmp/seed.sql
    login_user: root
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: Re-enable read_only/super_read_only on REPLICAS after import
  community.mysql.mysql_query:
    login_user: root
    query:
      - "SET GLOBAL read_only=ON"
      - "SET GLOBAL super_read_only=ON"
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_seed]

- name: CHANGE PRIMARY (GTID) on replicas
  community.mysql.mysql_replication:
    mode: changeprimary
    master_host: "{{ hostvars[groups['db_primary'][0]].ansible_host | default(groups['db_primary'][0]) }}"
    master_user: "repl"
    master_password: "{{ repl_password }}"
    master_port: 3306
    master_auto_position: yes
    login_user: root
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_replication]

- name: START REPLICA on replicas
  community.mysql.mysql_replication:
    mode: startreplica
    login_user: root
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_replication]

- name: Get replication status (replicas)
  community.mysql.mysql_replication:
    mode: getreplica
    login_user: root
  register: repl_status
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_check]

- name: Show replication summary (replicas)
  debug:
    var: repl_status
  when: inventory_hostname in groups['db_replicas']
  tags: [mysql, mysql_check]