---
# Runtime setup for Drupal web nodes (Rocky/Alma/RHEL 9)

- name: Update the package index on RHEL
  dnf:
    name: "*"
    state: latest
    update_cache: yes

- name: Set SELinux to permissive mode (runtime bootstrap)
  ansible.builtin.command: setenforce 0
  failed_when: false
  changed_when: false

- name: Ensure log directory exists
  file:
    path: /var/log
    state: directory
    mode: '0755'

- name: Create Log File
  file:
    path: "{{ log_file }}"
    state: touch

- name: Log output to a log file
  lineinfile:
    path: "{{ log_file }}"
    line: "Starting script..."
    state: present

# ---- Repos / PHP ----
- name: Install the GPG key for EPEL repository
  rpm_key:
    state: present
    key: https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-9

- name: Install EPEL repository
  dnf:
    name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
    state: present

- name: Enable PHP 8.2 module
  command: dnf module enable php:8.2 -y
  register: php_enable
  changed_when: "'enabled' in php_enable.stdout | lower or php_enable.rc == 0"
  failed_when: false

- name: Install PHP-8.2 module
  command: dnf module install php:8.2 -y
  when: php_enable.rc == 0
  changed_when: true
  failed_when: false

- name: Update package index and install required packages
  yum:
    update_cache: yes
    name:
      - wget
      - git
      - zip
      - supervisor
      - composer
      - nginx
      - php
      - php-cli
      - php-fpm
      - php-json
      - php-mysqlnd
      - php-pdo
      - php-zip
      - php-gd
      - php-intl
      - php-mbstring
      - php-curl
      - php-xml
      - php-pear
      - php-soap
      - php-bcmath
      - php-common
      - php-devel
      - patch
      - jq
    state: present

# ---- App checkout ----
- name: Check if the Git repository already exists
  stat:
    path: /var/www/html/shushportal
  register: repo_check

- name: Mark the repository as safe for Git
  command: git config --global --add safe.directory /var/www/html/shushportal
  changed_when: false
  failed_when: false

- name: Clone Git repository if it does not exist
  git:
    repo: "{{ git_repo }}"
    dest: "/var/www/html/shushportal"
    version: v-1.3-mobileworldcongress
    force: yes
  when: not repo_check.stat.exists

- name: Ensure the correct branch is checked out and up-to-date
  git:
    repo: "{{ git_repo }}"
    dest: "/var/www/html/shushportal"
    version: v-1.3-mobileworldcongress
    force: yes
    update: yes

- name: Install Composer dependencies
  ansible.builtin.shell: |
    set -e
    cd /var/www/html/shushportal
    export COMPOSER_ALLOW_SUPERUSER=1
    export COMPOSER_MEMORY_LIMIT=2G
    /usr/bin/composer install --no-interaction
  args:
    executable: /bin/bash


- name: Show DB variables from inventory (for visibility)
  debug:
    msg:
      - "db_name: {{ db_name }}"
      - "db_user: {{ db_user }}"
      - "db_host_primary: {{ db_host_primary }}"
      - "db_host_replica1: {{ db_host_replica1 }}"
      - "drush_target_host: {{ drush_target_host }}"

- name: Wait for PRIMARY MySQL to be ready
  wait_for:
    host: "{{ db_host_primary }}"
    port: 3306
    delay: 0
    timeout: 60

- name: Wait for REPLICA-1 MySQL to be ready
  wait_for:
    host: "{{ db_host_replica1 }}"
    port: 3306
    delay: 0
    timeout: 60

- name: Wait for local ProxySQL to be ready (if used)
  wait_for:
    host: 127.0.0.1
    port: "{{ proxysql_port }}"
    delay: 0
    timeout: 30
  when: use_proxysql | default(false)

- name: Template PHP settings file (PRIMARY + REPLICA)
  template:
    src: settings.php.j2
    dest: /var/www/html/shushportal/web/sites/default/settings.php
    mode: '0664'
    
# ---- Nginx / misc files ----
- name: Ensure Nginx sites-enabled directory exists
  file:
    path: /etc/nginx/sites-enabled
    state: directory
    mode: '0755'

- name: Ensure scripts directory
  file:
    path: /var/www/html/shushportal/scripts
    state: directory
    mode: '0755'

- name: Write drupal-nginx.conf
  template:
    src: drupal-nginx.conf
    dest: "{{ drupal_nginx_conf }}"

- name: Write nginx.conf
  template:
    src: nginx.conf
    dest: "{{ nginx_conf }}"

- name: Ensure the private directory exists
  file:
    path: /var/www/html/shushportal/private-files
    state: directory
    mode: '0755'

- name: copy salt file
  template:
    src: salt.txt
    dest: "{{ salt_file }}"

# ---- Users / perms ----
- name: Create devportal group
  group:
    name: devportal
    state: present
    system: yes

- name: Create devportal user
  user:
    name: devportal
    group: devportal
    home: /home/devportal
    shell: /bin/bash
    create_home: yes
    system: yes

- name: Change ownership of /var/www/html
  file:
    path: /var/www/html
    owner: devportal
    group: nginx
    state: directory
    recurse: yes

- name: Ensure set-permissions.sh is present and executable
  template:
    src: set-permissions.sh
    dest: "{{ set_permission_file }}"
    mode: '0755'

- name: Set permissions for the web dir
  file:
    path: /var/www/html/shushportal/web
    mode: '0775'
    recurse: yes
    owner: devportal
    group: nginx

# ---- Drush orchestration (only on the chosen host) ----
- name: Mark whether this host is the drush target
  set_fact:
    is_drush_target: >-
      {{ (ansible_host | default(inventory_hostname)) == (drush_target_host | string) }}

- name: Clear cache
  command: /var/www/html/shushportal/vendor/bin/drush cr
  register: drush_cr_output
  when: is_drush_target

- name: Show output for cache clear
  debug:
    var: drush_cr_output.stdout_lines
  when: is_drush_target

- name: Import configuration
  command: /var/www/html/shushportal/vendor/bin/drush cim -y
  register: drush_cim_output
  when: is_drush_target

- name: Show output for config import
  debug:
    var: drush_cim_output.stdout_lines
  when: is_drush_target

- name: Enable zcs_apis module
  command: /var/www/html/shushportal/vendor/bin/drush en zcs_apis -y
  register: drush_en_zcs_apis_output
  when: is_drush_target

- name: Show output for enabling zcs_apis
  debug:
    var: drush_en_zcs_apis_output.stdout_lines
  when: is_drush_target

- name: Enable shush theme
  command: /var/www/html/shushportal/vendor/bin/drush theme:en shush -y
  register: drush_theme_en_output
  when: is_drush_target

- name: Show output for enabling theme
  debug:
    var: drush_theme_en_output.stdout_lines
  when: is_drush_target

- name: Set default theme
  command: /var/www/html/shushportal/vendor/bin/drush config-set system.theme default shush -y
  register: drush_config_set_output
  when: is_drush_target

- name: Show output for setting default theme
  debug:
    var: drush_config_set_output.stdout_lines
  when: is_drush_target

- name: Enable zcs_user_management module
  command: /var/www/html/shushportal/vendor/bin/drush en zcs_user_management -y
  register: drush_en_zcs_user_management_output
  when: is_drush_target

- name: Show output for enabling zcs_user_management
  debug:
    var: drush_en_zcs_user_management_output.stdout_lines
  when: is_drush_target

- name: Enable zcs_client_management module
  command: /var/www/html/shushportal/vendor/bin/drush en zcs_client_management -y
  register: drush_en_zcs_client_management_output
  when: is_drush_target

- name: Show output for enabling zcs_client_management
  debug:
    var: drush_en_zcs_client_management_output.stdout_lines
  when: is_drush_target

# ---- API gateway selection (kong/aws/none) ----
- name: Validate apigateway value
  when: is_drush_target
  assert:
    that:
      - apigateway in ['kong', 'aws', 'none']
    fail_msg: "apigateway must be one of: kong, aws, none (got: {{ apigateway }})"

- name: Compute gateway enable/disable sets
  when: is_drush_target
  set_fact:
    gw_enable: "{{ ['zcs_kong'] if apigateway == 'kong' else (['zcs_aws'] if apigateway == 'aws' else []) }}"
    gw_disable: "{{ ['zcs_aws'] if apigateway == 'kong' else (['zcs_kong'] if apigateway == 'aws' else ['zcs_kong','zcs_aws']) }}"

- name: Get list of enabled modules
  when: is_drush_target
  command: /var/www/html/shushportal/vendor/bin/drush pml --status=enabled --format=list
  args: { chdir: /var/www/html/shushportal }
  register: drush_enabled_modules
  changed_when: false
  failed_when: false

- name: Enable desired gateway module(s) (only if disabled)
  when:
    - is_drush_target
    - gw_enable | length > 0
    - (drush_enabled_modules.stdout_lines | default([])) is iterable
    - item not in (drush_enabled_modules.stdout_lines | default([]))
  loop: "{{ gw_enable }}"
  loop_control: { label: "{{ item }}" }
  command: /var/www/html/shushportal/vendor/bin/drush en {{ item }} -y
  args: { chdir: /var/www/html/shushportal }
  register: drush_gw_enable
  failed_when: false

- name: Disable undesired gateway module(s) (only if enabled)
  when:
    - is_drush_target
    - gw_disable | length > 0
    - (drush_enabled_modules.stdout_lines | default([])) is iterable
    - item in (drush_enabled_modules.stdout_lines | default([]))
  loop: "{{ gw_disable }}"
  loop_control: { label: "{{ item }}" }
  command: /var/www/html/shushportal/vendor/bin/drush pmu {{ item }} -y
  args: { chdir: /var/www/html/shushportal }
  register: drush_gw_disable
  failed_when: false

- name: Run database updates
  command: /var/www/html/shushportal/vendor/bin/drush updb -y
  register: drush_updb_output
  when: is_drush_target

- name: Show output for database updates
  debug:
    var: drush_updb_output.stdout_lines
  when: is_drush_target

- name: Clear cache again
  command: /var/www/html/shushportal/vendor/bin/drush cr
  register: drush_cr_output_final
  when: is_drush_target

- name: Show output for final cache clear
  debug:
    var: drush_cr_output_final.stdout_lines
  when: is_drush_target

# ---- PHP-FPM / Nginx ----
- name: Change PHP-FPM user and group to nginx
  command: sed -i -e 's/^user = .*/user = nginx/' -e 's/^group = .*/group = nginx/' /etc/php-fpm.d/www.conf

- name: Restart PHP-FPM service
  systemd:
    name: php-fpm
    state: restarted

- name: Reload Nginx
  ansible.builtin.systemd:
    name: nginx
    state: reloaded

# ---- SELinux / services ----
- name: Ensure required SELinux packages are installed
  package:
    name: policycoreutils-python-utils
    state: present
  when: ansible_os_family == "RedHat"

- name: Allow PHP-FPM (Nginx) to connect to a remote database
  seboolean:
    name: httpd_can_network_connect_db
    state: yes
    persistent: yes

- name: Ensure Nginx and PHP-FPM start on boot
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  loop: [ nginx, php-fpm ]

# ---- Build meta ----
- name: Ensure Git directory is marked safe
  shell: git config --global --add safe.directory /var/www/html/shushportal
  args: { chdir: /var/www/html/shushportal }
  changed_when: false
  failed_when: false

- name: Get latest Git tag
  shell: git describe --tags --abbrev=0 || echo "v0.0.0"
  args: { chdir: /var/www/html/shushportal }
  register: version_tag

- name: Get Git commit SHA
  shell: git rev-parse HEAD
  args: { chdir: /var/www/html/shushportal }
  register: commit_sha

- name: Get Git branch name
  shell: git rev-parse --abbrev-ref HEAD
  args: { chdir: /var/www/html/shushportal }
  register: branch_name

- name: Get Drupal version via Drush
  shell: /var/www/html/shushportal/vendor/bin/drush status | grep 'Drupal version' | awk -F ':' '{gsub(/^[ \t]+/, "", $2); print $2}'
  register: drupal_version

- name: Get build date (UTC)
  shell: date -u +'%Y-%m-%dT%H:%M:%SZ'
  register: build_date

- name: Create version.json
  copy:
    dest: /var/www/html/shushportal/web/version.json
    content: |
      {
        "version": "{{ version_tag.stdout }}",
        "commit": "{{ commit_sha.stdout }}",
        "branch": "{{ branch_name.stdout }}",
        "build_date": "{{ build_date.stdout }}",
        "environment": "{{ environment | default('unknown') }}",
        "drupal_version": "{{ drupal_version.stdout }}"
      }

- name: Echo version path
  debug:
    msg: "version.json created at /var/www/html/shushportal/web/version"

- name: Log completion message
  lineinfile:
    path: "{{ log_file }}"
    line: "Startup script completed successfully."
    state: present
